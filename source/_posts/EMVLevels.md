title: EMVLevels
date: 2015-11-02 08:53:19
tags:
---

[[TOC]]

# EMVCo Approval Levels Explained

The purpose of this blog post is to explain Level 1, Level 2, and Level 3 EMV terminal testing in plain English, without using a bunch of acronyms and industry jargon. EMV terminal testing is the process of testing that must occur in order for a payment terminal (think Point-Of-Sale (POS) system) to accept real transactions.

EMV Compliance testing has two official levels: EMV Level 1 (which tests the physical and electrical aspects of the terminal as well as the terminal's ability to transport information to/from the smart card) and EMV Level 2 (which tests the communication between the payment terminal and the smart card). After passing Level 1 and Level 2 EMV tests, the full terminal-to-card-processor system must be certified by the card brands, e.g. VISA or MasterCard; this process is commonly referred to as "Level 3 testing," even though it is not an official test from EMVCo (the EMV standards and regulation committee).

# Level 1 Testing
EMVCo's stated purpose for Level 1 testing is  "to maximize confidence that ICCs and terminals do not damage each other, and that ICCs [smart cards] and terminals function together correctly up to the point of exchanging information."

In other words, the Level 1 EMV testing ensures that the terminal can correctly send, receive, and acknowledge commands from the smart card. 

Often times people say that Level 1 testing is for the "terminal hardware" and Level 2 testing is for the "terminal firmware." This isn't true. From [EMVCo Type Approval Contact Terminal Level 1 Administrative Process](https://www.emvco.com/approvals.aspx?id=56), Level 1 testing tests and verifies "the necessary hardware and software to power the ICC [smart card] and to support communication between the terminal and the ICC [smart card] up to the fourth OSI [Open Systems Interface] layer (transport layer)."

In actuality, the majority of Level 1 tests verify the sending, receiving, and acknowledging of commands from the smart card, which directly involves the firmware running on the terminal. The firmware is such an essential part of this testing that various companies have firmware offerings specifically for Level 1 testing, e.g. see [Credit Call's EMVL1.LIB](https://www.level2kernel.com/emv-level-1-library.html). 


## Example Level 1 Tests
Let's take a look at some actual Level 1 tests to get a better feel for what's being tested.

###  Example Mechanical Test (Test 1CA.001.0x)

    To ensure that the physical characteristics of the interface module allow
    the acceptance of ICCs [smart cards] having a size between the minimum and
    the maximum standard dimensions, and that galvanic contact is established
    between the interface module and reference probes having minimal area contacts.


Simple enough: this test verfies that the card slot on the terminal allows the card to fit inside of it correctly and make electric contact with the electrical pads. 

### Example Electrical Test (Test 1CB.017.0x)
    To ensure that the supply voltage generated by the payment terminal being tested
    remains within specified limits under dynamic load conditions.


This test makes sure the terminal can't produce enough voltage to damage the smart card.


### Example "Answer To Reset" Test (Test 1CE.001.00)
    To ensure that the IUT correctly receives and interprets an ATR (Answer To Reset Command)
    with a character-to-character time of 11.8 initial etus [withing a certain time interval].

After a smart card is reset by the terminal, the smart card answers with a string of bytes known as the Answer To Reset (ATR). These bytes tell the terminal how it should establish communication with that particular smart card.  In this test, the terminal must correctly receive various ATR commands and return expected responses. This is a test that requires the firmware running on the terminal to successfully parse and handle ATR commands.

### Example Transport Layer Test (1CF.152.0y)
    To ensure that the terminal correctly processes a '6C' procedure byte sent in
    response to a case 2 command header.


This test makes sure that the terminal correctly receives, processes, and responds to a particular command response sent from the smart card. Similar to the previous example test, this test targets the firmware running on the terminal.


## Level 1 FAQ #1: Are the Level 1 Tested Components Separate From The EMV Terminal?

They can be! The portion of the payment terminal that undergoes Level 1 EMV testing falls under three categories:

* **Modular**: The components and interfaces of the terminal that pertain to the Level 1 testing constitute a separate subassembly within the terminal and can be clearly identified and separated. Changing the functionality of the rest of the terminal does not impact the components or interfaces pertaining to Level 1 testing.

* **Distributed**: The components and interfaces of the terminal that pertain to the Level 1 testing are distributed throughout the payment terminal but can be clearly identified (though not necessarily separated). As with the modular implementation, changing the functionality of the rest of the terminal does not impact the components or interfaces pertaining to Level 1 testing.

* **Integrated**: The components and interfaces of the terminal that pertain to the Level 1 testing are distributed throughout the payment terminal and *cannot* be clearly idenetified or separated . Changing the functionality of the rest of the terminal can impact the components or interfaces pertaining to Level 1 testing.

See Section 4 of [EMVCo Type Approval Contact Terminal Level 1 Administrative Process](https://www.emvco.com/approvals.aspx?id=56), 

## Level 1 FAQ #2: Does a Testing Laboratory Have to Perform Level 1 Tests?
Yes. An EMVCo approved Test Facility must perform Level 1 testing. EMVCo does not recognize self-certification.

## Level 1 FAQ #3: How Long Does Level 1 Testing Take and How Expensive is It?
This depends on how long it takes to pass all of the tests. For first time Level 1 certification, i.e. not recertifiction of a previously certified terminal, it typcally takes 12-18 months according to TODO(cjrd) provide reference. Including development costs, it's estimated that EMV Level 1 certification can cost $100,000-$300,000.


# Level 2 Testing

The EMV level 2 kernel is a software application that implements the full EMV specification for performing a transaction (not including the part of the specification that pertains to Level 1 testing).  The job of the kernel code is to generate all the EMV commands to send to the smart card and processes and manage the responses from the smart card. The Level 2 EMV testing makes sure that all of the commands are generated according to the EMV specification and all of the responses from the smart card are processed according to the EMV specification.

The Level 2 kernel code itself will not enable EMV payments on a terminal: there must be additional code that communicates with the kernel code that handles the payment logic.  This additional code can either exist on the terminal or on a separate microcontroller that communicates with the terminal, e.g. over USB or Bluetooth. Similar to the software for Level 1 certification, it is possible to architect a modular Level 2 kernel that can be used for several implementations. This allows companies to license precertified Level 2 kernels, e.g. the [Level 2 Kernel from Credit Call](https://www.level2kernel.com/emv-kernel.html).

EMV Level 2 compliance is issued for a specific configuration of the kernel software running on a specific operating system with specific EMV Level 1 certified hardware. If either the kernel configuration, operating system, or hardware changes, then the kernel must be recertfied.  Note, however, that it is possible to certify multiple kernel configurations and hardware options simultaneously, but EMVCo charges around $500 for each additional test (see "Cost" below).

## Example Level 2 Test (2CC.022.00)
For completeness, here's an example Level 2 test:

    To ensure that the terminal fails the Static Data Authentication process
    if the Certificate Expiration Date has expired.

This test checks that if the test card presents an expired encryption file then the terminal should reject the transaction. Simple, right?

## Level 2 FAQ #1: Does a Testing Laboratory Have to Perform Level 2 Tests?
es. An EMVCo approved Test Facility must perform Level 1 testing. EMVCo does not recognize self-certification.


## Level 2 FAQ #2: How Long Does Level 2 Testing Take and How Expensive is It?
This depends on how long it takes to pass all of the tests. For first time Level 2 certification, i.e. not recertifiction of a previously certified kernel, it typcally takes 12-18 months according to TODO(cjrd) provide reference. Including development costs, it's estimated that EMV Level 2 kernel certification can cost $100,000-$300,000.



# Level 3 Testing (Terminal Integration Testing)

Terminal integration testing (often referred to as "Level 3" Testing) takes place with Level 1 and 2 certified harware and software solution. The goal of Level 3 testing is to make sure that the terminal-to-card-processor communication channel has been correctly established,  and the full payment flow can take place. Unlike Level 1 and Level 2 testing, Level 3 testing is not done by EMVCo, but rather, each card brand has its own set of tests that verify that an end-to-end EMV transaction works.

It's very important to the card brands (Visa, MasterCard, etc) that EMV credit cards with their brand on them work out in the wild: they don't their cards to have a reputation of not working on payment terminals. So, each card brand has required a final level of testing in order to reduce the possibility that their cards experience issues communicating data to the processing network, or that the code that manages the transaction flow doesn't work correctly with their card.

The testing process is different for each card brand, but generally speaking, the Level 3 testing has four steps:

1. **Setup/Execution of Tests**: Obtain the card-brand-specific test plan and a qualified test tool and the pass the brand-specified test cases. 
2. **Submit Results**: Submit test results to either the card brand or a designated third party.
3. **Result Validation**: The results of the tests are validated by either the card brand or a designated third party.
4. **Sign-off**: The card bard approves/denies the terminal integration test.


Level 3 testing must be performed for each distinct POS configuration that will be deployed. A distinct POS configuration is defined as the unique set of:
* The Level 2 kernel software
* The terminal software that handles the payment application software as well as the terminal-to-acquirer communication software.
* The terminal configuration, e.g. the configuration of the Level 2 kernel, the enabled terminal capabilities, etc
* The connection path from the terminal to the card brand. TODO(cjrd) what exactly does this include

To get a better feel for this testing process, let's take a look at MasterCard's Level 3 certification process.

## Example Level 3 Testing: MasterCard
The Level 3 testing for MasterCard is known as the MasterCard Terminal Integration Process (M-TIP). The information presented in this section was taken from the [M-TIP manual from MasterCard's paypass.com](https://www.paypass.com/TIP/MTPG_Manual.pdf).

### M-TIP Prerequisites
According to the M-TIP manual, the following prerequisites must be met before starting M-TIP:
1. Selection of an approved terminal with valid EMVCo Level 1 and Level 2 Letters of Approval.
2. Successful completion of Network Interface Validation
3. Setup of the terminal and acquirer host system
4. Procurement of a qualified M-TIP Test Tool, i.e. the relevant MasterCard simulator and the M-TIP documentation (Questionnaire, user guide, etc.)
5. Selection of a TIP Service Provider: the testing company must submit their Level 3 Test results to an accredited TIP Service Provider.

The first prerequisite is straightforward: a Level 1 and Level 2 certified terminal must be used during testing (see the above sections for a discussion on Level 1 and Level 2 testing).

The second prerequisite is trickier: before beginning M-TIP certification, the company pursuing the Level 3 certification must complete MasterCard's Network Interface Validation TODO(cjrd) MasterCard Connect> Publications> Testing Reference Information Center.

The third prerequisite states that the terminal must be able to successfully send/receive information to/from the processing network TODO(cjrd) verify this.

The fourth and fifth prerequisites state that the company pursuing the Level 3 certification must have the correct testing tools and will need an approved company to certify the results of the tests they run.

### M-TIP Testing
MasterCard's M-TIP approval process has six steps:

1. M-TIP Requirements Capture and Validation
2. Generate M-TIP Tests
3. Order M-TIP Service from Service Provider  TODO what is this?
4. Prepare for M-TIP Testing
5. Perform M-TIP Testing
6. Request M-TIP Letter of Approval


Point of note for the following subsections: the term **acquirer** refers to the company performing the M-TIP testing.

#### M-TIP Requirements Capture and Validation

In this step, the Acquirer has to obtain and complete the M-TIP questionnaire from [MasterCard Connect](TODO). The questionnaire is a Microsoft Excel workbook. The workbook is effectively a form that the testing company uses to provide details about the terminal being tested, e.g. the terminal brand and model, the EMV application kernel used, EMV Level 1 and Level 2 approval references, etc.


#### Generate M-TIP Tests
In this step, the acquirer figures out the set of tests that they need to perform based on the responses they provide in the M-TIP Questionnaire. In M-TIP testing, there are up to 264 tests that could be applicable.

##### Order M-TIP Service
In this step, the acquirer places an order for the M-TIP Service with their chosen Service Provider. Acquirers must select a MasterCard Accredited Third Party from the M-TIP Formal Approval category. The list of Accredited Third Parties is provided in [MasterCard Connect]() > Publications> Chip Information Center. The tasks that need to be done in this subprocess depend on the chosen service provider as each has their own specific way of working.

#### Prepare for M-TIP Testing
To successfully execute the M-TIP test plans, the acquirer needs the appropriate test cards and a means of capturing, logging and validating the interaction between the terminal and cards. There are hundreds of different test cases and test cards, so most acquirers use automated software emulation tools that can be used instead of manually executing the tests with the physical test cards. These software emulation tools facilitate the execution of the test cases, indicate pass/fail results of the test cases, and save the results in a format that can be directly submitted to the card brand.  The [UL Transaction Securityâ€™s Collis Brand Test Tool] has been approved for all four major brands and can be used for MasterCard M-TIP testing.

#### Perform M-TIP Testing
Iterating through each of the test transactions is fairly straightforward with the Collis Brand Test Tool from UL. The tricky part is figuring out why tests fail and what needs to be done in order to fix the failing test.

#### Request M-TIP Letter of Approval
After the acquirer has successfully passed all necessary tests, the acquirer submits the test results/logs and requests a Letter of Approval from MasterCard.

## Level 3 FAQ #1: Does a Testing Laboratory Have to Perform Level 3 Tests?
Whether or not a testing laboratory has to perform level 3 tests depends on card brand specifications. At the time of this writing, most card brands allow companies to conduct Level 3 testing and have the results approved by either the card brand or a certified third party.


## Level 3 FAQ #2: How Long Does Level 3 Testing Take and How Expensive is It?
This depends on the card brand, the application under test, the experience of the testers, etc. At a minimum, the [UL testing tool]() cost approximately $XYZ, and submission of the test results to the four major card brands costs:

* Visa: $XYZ
* MasterCard: $XYZ
* American Express: $XYZ 
* Discover: $XYZ


### References
Here's an assorted collection of educational and reference material used to write this blog post.
* [EMV FAQs for Developers](http://www.gorspa.org/files/public/RSPA_EMV-FAQs-for-Developers.pdf)

* [Level 2 resources](https://www.level2kernel.com)

* [Level 3 casual overview](http://stackoverflow.com/questions/21065242/emv-applicaton-development-questions)

* [Heartland EMV's Integrator Guide]()


Content TODO
* Semi-integrated vs fully integrated?


TODO:
 * Figure out UL testing price
 * Figure out submission costs
 * Add in an example L3 test?
