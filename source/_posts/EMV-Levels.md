# EMVCo Approval Levels Explained

The purpose of this blog post is to explain Level 1, Level 2, and Level 3 EMV testing in plain English, without using a bunch of acronyms and industry jargon.
EMVCo, a standards and regulations group with control split equally among the 6 major credit card brands, 

[Wiki] EMV Compliance testing has two levels: EMV Level 1, which covers physical, electrical and transport level interfaces, and EMV Level 2, which coversf payment application selection and credit financial transaction processing. After passing common EMVCo tests, the software must be certified by payment brands to comply with proprietary EMV implementations such as Visa VSDC, American Express AEIPS, MasterCard MChip, JCB JSmart, or EMV-compliant implementations of non-EMVCo members such as LINK in the UK, or Interac in Canada.

EMVCo’s objective is that terminals, used for any transaction within the payment
systems of EMVCo’s members (i.e. Europay International, MasterCard International and
VISA International), conform to the EMV Specification.


## Level 1 Approval
EMVCo's stated purpose for Level 1 testing is  "to maximize
confidence that ICCs and terminals do not damage each other, and that ICCs [smart cards] and
terminals function together correctly up to the point of exchanging information."

In other words, the Level 1 EMV testing ensures that the terminal can correctly send, receive, and acknowledge commands from the smart card. 

Often times I've heard people say that Level 1 testing is for the terminal hardware and Level 2 testing is for the firmware
running on the terminal. This isn't true. From [EMVCo Type Approval Contact Terminal Level 1 Administrative Process](https://www.emvco.com/approvals.aspx?id=56), Level 1 testing
tests and verifies "the necessary hardware and software to power the ICC [smart card] and to support communication
between the terminal and the ICC [smart card] up to the fourth OSI [Open Systems Interface] layer (transport layer)."

The majority of Level 1 tests verify the sending, receiving, and acknowledging of commands
from the smart card, which directly involves the firmware running on the terminal. In fact, various companies have firmware offerings
specifically for Level 1 testing, e.g. see [Credit Call's EMVL1.LIB](https://www.level2kernel.com/emv-level-1-library.html). 

TODO(cjrd) once known,
discuss what L2 testing is used for


### Example Level 1 Tests
Let's take a look at an some actual Level 1 tests to get a better feel for what's being tested.

####  Example Mechanical Test (Test 1CA.001.0x)
```
To ensure that the physical characteristics of the interface module allow the acceptance of
ICCs [smart cards] having a size between the minimum and the maximum standard
dimensions, and that galvanic contact is established between the interface module and
reference probes having minimal area contacts.
```

Simple enough: this test verfies that the card slot on the terminal allows the card to fit inside of it
correctly and make electric contact with the electrical pads. 

#### Example Electrical Test (Test 1CB.017.0x)

```
To ensure that the supply voltage generated by the payment terminal being tested remains within
specified limits under dynamic load conditions.
```

This test makes sure the terminal can't produce enough voltage to damage the smart card.


#### Example "Answer To Reset" Test (Test 1CE.001.00)
```
To ensure that the IUT correctly receives and interprets an ATR (Answer To Reset Command) with a
character-to-character time of 11.8 initial etus.
```

After a smart card is reset by the terminal, the smart card answers
with a string of bytes known as the Answer To Reset (ATR). These bytes tell the terminal
 how it should establish communication with that particular smart card.  In this test, the terminal must
correctly receive various ATR commands and return expected responses. 
This is a test that requires the firmware running on the terminal to successfully parse
and handle ATR commands.

#### Example Transport Layer Test (1CF.152.0y)
```
To ensure that the terminal correctly processes a '6C' procedure byte sent in
response to a case 2 command header.
```

This test makes sure that the terminal correctly receives, processes, and responds to a particular command response sent from the smart card.
Similar to the previous example test, this test targets the firmware running on the terminal.


### Are the Level 1 Tested Components Separate From The EMV Terminal?

They can be! The portion of the payment terminal that undergoes Level 1 EMV testing falls under three categories:

* **Modular**: The components and interfaces of the terminal that pertain to the Level 1 testing constitute a separate subassembly within the terminal and can be clearly identified and separated. Changing the functionality of the rest of the terminal does not impact the components or interfaces pertaining to Level 1 testing.

* **Distributed**: The components and interfaces of the terminal that pertain to the Level 1 testing are distributed throughout the payment terminal but can be clearly identified (though not necessarily separated). As with the modular implementation, changing the functionality of the rest of the terminal does not impact the components or interfaces pertaining to Level 1 testing.

* **Integrated**: The components and interfaces of the terminal that pertain to the Level 1 testing are distributed throughout the payment terminal and *cannot* be clearly idenetified or separated . Changing the functionality of the rest of the terminal can impact the components or interfaces pertaining to Level 1 testing.

See Section 4 of [EMVCo Type Approval Contact Terminal Level 1 Administrative Process](https://www.emvco.com/approvals.aspx?id=56), 

### Does a Testing Laboratory Have to Perform Level 1 Tests?
Yes. An EMVCo approved Test Facility must perform Level 1 testing. EMVCo does not recognize self-certification.

### How Long Does Level 1 Testing Take and How Expensive is It?
TODO(cjrd)


## Level 2 Approval


The EMV level 2 kernel is a software application that implements the full EMV specification for performing a transaction (not including the part of the specification that pertains to Level 1 testing). 
The job of the kernel code is to generate all the EMV commands to send to the card and processes all of its responses. 
The Level 2 EMV testing makes sure that all of the commands are generated according to the EMV specification and all of the responses from
the smart card are processed according to the EMV specification.

The Level 2 kernel code itself will not enable EMV payments on a terminal: there must be additional code that communicates with the kernel code that handles the payment logic. 
This additional code can either exist on the terminal or on a separate microcontroller that communicates with the terminal, e.g. over USB or Bluetooth. 
Similar to the software for Level 1 certification, it is possible to architect a modular Level 2 kernel that can be used across several devices.
This allows companies to license precertified Level 2 kernels, e.g. the [Level 2 Kernel from Credit Call](https://www.level2kernel.com/emv-kernel.html).

EMV Level 2 compliance is issued for a specific configuration of the kernel software running on a specific operating system with specific EMV Level 1 certified hardware.
If either the kernel configuration, operating system, or hardware changes, then the kernel must be recertfied. 
Note, however, that it is possible to certify multiple kernel configurations and hardware options simultaneously, but EMVCo charges around $500 for each additional test (see "Cost" below).

### Does a Testing Laboratory Have to Perform Level 2 Tests?
Yes. An EMVCo approved Test Facility must perform Level 1 testing. EMVCo does not recognize self-certification.


### How Long Does Level 2 Testing Take and How Expensive is It?
TODO(cjrd)



## Level 3 Approval (Terminal Integration Testing)

Terminal integration testing (often referred to as "Level 3" Testing) takes place with Level 1 and 2 certified harware and software solution.
The goal of Level 3 testing is to make sure that the terminal-to-card-processor communication channel has been correctly established, 
and the full payment flow can take place. Unlike Level 1 and Level 2 testing, Level 3 testing is not done by EMVCo, but rather,
each card brand has its own set of tests that verify that an end-to-end EMV transaction works.

It's very important to the card brands (Visa, Mastercard, etc) that EMV credit cards with their brand on them work out in the wild:
they don't want to develop a reputation of having cards that "just don't work."
So, each card brand has required a final level of testing in order to reduce the possibility that their cards experience issues communicating data to the processing network,
or that the code that manages the transaction flow doesn't work correctly with their card.

The testing process is different for each card brand, but generally speaking, the Level 3 testing has four steps:

1. **Setup/Execution of Tests**: Obtain the card-brand-specific test plan and a qualified test tool and the pass the brand-specified test cases. 
2. **Submit Results**: Submit test results to either the card brand or a designated third party.
3. **Result Validation**: The results of the tests are validated by either the card brand or a designated third party.
4. **Sign-off**: The card bard approves/denies the terminal integration test.

### Example Level 3 Testing: Mastercard
The Level 3 testing for Mastercard is known as the Mastercard Terminal Integration Process (M-TIP). 
The information presented in this section was taken from the (M-TIP manual from Mastercard's paypass.com](https://www.paypass.com/TIP/MTPG_Manual.pdf).

According to the M-TIP manual, the following prerequisites must be met before starting M-TIP:
1. Selection of an approved terminal with valid EMVCo Level 1 and Level 2 Letters of Approval.
2. Successful completion of Network Interface Validation
3. Setup of the terminal and acquirer host system
4. Procurement of a qualified M-TIP Test Tool, i.e. the relevant MasterCard simulator and the M-TIP documentation (Questionnaire, user guide, etc.)
5. Selection of a TIP Service Provider: the testing company must submit their Level 3 Test results to an accredited TIP Service Provider.

The first prerequisite is straightforward: a Level 1 and Level 2 EMVCo certified terminal must be used during testing.

The second prerequisite is trickier: before beginning M-TIP certification, the company pursuing the Level 3 certification 
must complete Mastercard's Network Interface Validation TODO(cjrd) MasterCard Connect> Publications> Testing Reference
Information Center.

The third prerequisite states that the terminal must be able to successfully send/receive information to/from the processing network TODO(cjrd) verify this.

The fourth and fifth prerequisites state that the company pursuing the Level 3 certification must have the correct testing tools and will need an approved company to certify the results of the tests they run.


### Does a Testing Laboratory Have to Perform Level 3 Tests?
Whether or not a testing laboratory has to perform level 3 tests depends on card brand specifications. 
At the time of this writing, most card brands (TODO list them here) allow companies to conduct Level 3 testing
and have the results approved by either the card brand or a certified third party.


### How Long Does Level 3 Testing Take and How Expensive is It?
This depends on the card brand, the application under test, the experience of the testers, etc. 

* Visa: test cards and software: $1000
* Mastercard: ...
* American Express 



Educational Links
* [EMV FAQs for Developers](http://www.gorspa.org/files/public/RSPA_EMV-FAQs-for-Developers.pdf)

& [Level 2 resources](https://www.level2kernel.com)

* [Level 3 casual overview](http://stackoverflow.com/questions/21065242/emv-applicaton-development-questions)




Questions:
* Can we use a L2 kernel on L1 certified hardware/processors? What do we do, then, go for L3 testing???
* PA-DSS vs PCI-DSS
* Semi-integrated vs fully integrated?

